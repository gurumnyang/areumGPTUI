<!DOCTYPE html>
<html lang="ko" data-bs-theme="dark">
<head>
  <meta charset="UTF-8" />
  <title>ChatGPT-like Chat</title>
  <!-- Bootstrap 5 -->
  <link
          href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
          rel="stylesheet"
  >
  <!-- jQuery -->
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.4/dist/jquery.min.js"></script>
  <!-- Bootstrap Bundle (JS) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- 마크다운 파싱 라이브러리 (marked) + XSS 방어 (DOMPurify) -->
  <script src="https://cdn.jsdelivr.net/npm/marked@4.3.0/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@2.4.1/dist/purify.min.js"></script>

  <style>
    body {
      background-color: #212121; /* 다크모드 느낌 */
      color: #e0e0e0;
      margin: 0;
      padding: 0;
      height: 100vh;
      overflow: hidden;
    }
    .chat-container {
      display: flex;
      height: 100vh;
      overflow: hidden;
    }
    /* --- 사이드바 --- */
    .sidebar {
      background-color: #171717;
      height: 100%;
      overflow-y: auto;
      width: 260px;
      position: relative;
      transition: width 0.3s;
    }
    .sidebar.collapsed {
      width: 0;
      overflow: hidden;
    }
    /* 사이드바 헤더(버튼들) */
    .sidebar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 10px;
      border-bottom: 1px solid #444;
    }

    /* 채팅 목록 */
    .chat-history-list {
      list-style: none;
      padding-left: 0.75rem;
      padding-right: 0.75rem;
      margin: 0;
    }
    .chat-history-list li {
      position: relative;
      padding: 8px;
      cursor: pointer;
      border-radius: 4px;
    }
    .chat-history-list span {
      font-size:.875rem;
    }
    .chat-history-list li:hover {
      background-color: #212121;
    }

    .chat-options-btn {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      display: none; /* 기본은 숨김 */
      background: none;
      border: none;
      color: #ccc;
      font-size: 16px;
      cursor: pointer;
    }
    .chat-history-list li:hover .chat-options-btn {
      display: inline;
    }
    .chat-options-menu {
      position: absolute;
      right: 40px;
      top: 50%;
      transform: translateY(-50%);
      background-color: #2e2e2e;
      border: 1px solid #555;
      border-radius: 4px;
      display: none;
      z-index: 10;
      padding: 4px 0;
    }
    .chat-options-menu a {
      color: #fff;
      text-decoration: none;
      display: block;
      padding: 4px 8px;
      font-size: 14px;
      white-space: nowrap;
    }
    .chat-options-menu a:hover {
      background-color: #4f4f4f;
    }

    /* --- 메인 채팅 --- */
    .main-chat {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      position: relative;
    }
    .top-bar {
      background-color: #212121;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 20px;
      border-bottom: 1px solid #555;
      position: relative;
    }
    /* 메인 상단 바의 버튼 세트 */
    .top-bar-buttons {
      display: none; /* 기본은 숨김 */
    }
    .messages-area {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      max-width: 48rem;
      width: 100%;
      margin: 0 auto;
    }
    .message-bubble {
      margin-bottom: 32px;
      opacity: 0;
      animation: fadeIn 0.3s forwards;
      line-height: 1.5;
    }
    .message-bubble.user {
      text-align: right;
    }
    .message-bubble.assistant {
      text-align: left;
    }
    .bubble-content {
      display: inline-block;
      padding: 10px 15px;
      border-radius:22px;
    }
    .user .bubble-content {
      background-color: #303030;
      color: #fff;
    }
    .user .bubble-content p {
        margin: 0;
    }
    .assistant .bubble-content {
      color: #e0e0e0;
    }

    @keyframes fadeIn {
      to { opacity: 1; }
    }
    /* --- 입력 영역 (다크모드) --- */
    .bottom-bar {
      padding: 10px 20px;
      border-top: 1px solid #555;
      background-color: #303030;
      border-radius: 22px;
      width: 100%;
      max-width: 44rem;
      margin: 0 auto;
    }
    .form-control {
      background-color: #333;
      color: #e0e0e0;
      border: 1px solid #555;
    }
    .form-control:focus {
      background-color: #424242;
      color: #fff;
      outline: none;
      box-shadow: none;
    }

    /* --- 프로필 --- */
    .profile-tab {
      cursor: pointer;
      display: flex;
      align-items: center;
    }
    .profile-tab img {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      margin-right: 8px;
    }
    .profile-dropdown {
      position: absolute;
      top: 50px;
      right: 20px;
      background-color: #3a3a3a;
      border: 1px solid #555;
      border-radius: 4px;
      display: none;
      padding: 10px;
      z-index: 999;
    }
    .profile-dropdown a {
      color: #fff;
      text-decoration: none;
      display: block;
      padding: 5px 0;
    }
    .profile-dropdown a:hover {
      background-color: #4f4f4f;
    }
    /* 스크롤바 커스텀 (선택사항) */
    ::-webkit-scrollbar {
      width: 8px;
    }
    ::-webkit-scrollbar-track {
      background: #3a3a3a;
    }
    ::-webkit-scrollbar-thumb {
      background: #555;
    }

    /*마크다운 스타일*/

    .markdown pre {
      margin-top: .5rem
    }

    .markdown pre:first-child {
      margin-top: 0
    }

    .markdown h1 {
      font-weight: 700;
      letter-spacing: -.04rem
    }

    .markdown h1:first-child {
      margin-top: 0
    }

    .markdown h2 {
      font-weight: 600;
      margin-bottom: 1rem;
      margin-top: 2rem
    }

    .markdown h2:first-child {
      margin-top: 0
    }

    .markdown h3 {
      font-weight: 600;
      margin-bottom: .5rem;
      margin-top: 1rem
    }

    .markdown h3:first-child {
      margin-top: 0
    }

    .markdown h4 {
      font-weight: 600;
      margin-bottom: .5rem;
      margin-top: 1rem
    }

    .markdown h4:first-child {
      margin-top: 0
    }

    .markdown h5 {
      font-weight: 600
    }

    .markdown h5:first-child {
      margin-top: 0
    }

    .markdown blockquote {
      --tw-border-opacity: 1;
      border-color: rgb(155 155 155/var(--tw-border-opacity));
      line-height: 1.5rem;
      margin: 0;
      padding-bottom: .5rem;
      padding-top: .5rem
    }

    [dir=ltr] .markdown blockquote {
      border-left-width: 2px;
      padding-left: 1rem
    }

    [dir=rtl] .markdown blockquote {
      border-right-width: 2px;
      padding-right: 1rem
    }

    .markdown p {
      margin-bottom: .5rem
    }

    .markdown p:not(:first-child) {
      margin-top: .5rem
    }

    .markdown p+:where(ol,ul) {
      margin-top: 0
    }

    .markdown :where(ol,ul)>li>:last-child {
      margin-bottom: 0
    }

    .markdown :where(ol,ul)>li>:first-child {
      margin-bottom: 0;
      margin-top: 0
    }

  </style>
</head>
<body>
<div class="chat-container">
  <!-- 사이드바 -->
  <div class="sidebar" id="sidebar">
    <div class="sidebar-header" id="sidebarHeader">
      <!-- 사이드바 열려 있을 때 보이는 버튼 -->
      <button id="toggleSidebarBtnSide" class="btn btn-sm btn-secondary">&laquo;</button>
      <button id="newChatBtnSide" class="btn btn-sm btn-primary">새 채팅</button>
    </div>
    <ul id="historyList" class="chat-history-list"></ul>
  </div>

  <!-- 메인 채팅 영역 -->
  <div class="main-chat">
    <!-- 상단 바 -->
    <div class="top-bar">
      <h5 class="m-0 fw-bold">ChatGPT</h5>

      <!-- 사이드바가 닫혀있을 때 나타날 버튼 세트 -->
      <div class="top-bar-buttons" id="topBarButtons">
        <button id="toggleSidebarBtnTop" class="btn btn-sm btn-secondary">&raquo;</button>
        <button id="newChatBtnTop" class="btn btn-sm btn-primary">새 채팅</button>
      </div>

      <div class="profile-tab" id="profileTab">
        <img src="https://via.placeholder.com/32" alt="Profile"/>
        <span id="profileEmail">User</span>
      </div>
      <!-- 프로필 드롭다운 -->
      <div class="profile-dropdown" id="profileDropdown">
        <a href="#" id="logoutBtn">로그아웃</a>
      </div>
    </div>

    <!-- 메시지 영역 -->
    <div id="messagesArea" class="messages-area"></div>

    <!-- 입력 영역 -->
    <div class="bottom-bar mb-1">
      <div class="input-group">
        <textarea id="userInput" class="form-control" rows="1" placeholder="무엇이든 물어보세요"></textarea>
        <button id="sendBtn" class="btn btn-primary">전송</button>
      </div>
    </div>
    <p class="text-muted small m-auto">AreumGPT는 실수를 할 수 있습니다.</p>

  </div>
</div>

<script>

  // 마크다운 옵션 (줄바꿈/breaks, GFM 등)
  marked.setOptions({
    breaks: true,     // 일반 줄바꿈도 <br>로 처리
    gfm: true         // GitHub Flavored Markdown
  });

  let sseSource = null;
  let currentChatId = null;
  let isSidebarOpen = true; // 사이드바 초기 상태 (열림)

  $(function() {
    // 프로필 탭 클릭 시 드롭다운 표시
    $('#profileTab').on('click', function() {
      $('#profileDropdown').toggle();
    });

    // 로그아웃
    $('#logoutBtn').click(function(e) {
      e.preventDefault();
      window.location.href = '/api/logout';
    });

    // 사이드바 열림/닫힘 토글
    $('#toggleSidebarBtnSide').click(function() {
      // 사이드바 "닫기" (버튼이 사이드바 안에 있을 때)
      toggleSidebar(false);
    });
    $('#toggleSidebarBtnTop').click(function() {
      // 사이드바 "열기" (버튼이 상단 바에 있을 때)
      toggleSidebar(true);
    });

    // 새 채팅 버튼 (사이드바 / 상단 바 둘 다 같은 함수)
    $('#newChatBtnSide').click(createNewChatOnServer);
    $('#newChatBtnTop').click(createNewChatOnServer);

    // 메시지 전송
    $('#sendBtn').click(sendUserMessage);
    // 엔터키 전송
    $('#userInput').keypress(function(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendUserMessage();
      }
    });

    // 초기 상태
    updateSidebarUI();

    // 사이드바의 기존 채팅목록 불러오기
    fetchChatHistoryList();

    // 프로필 정보 불러오기
    fetchProfile();
  });

  /* --------------------------------
   * 사이드바 열림/닫힘 상태 변경
   * -------------------------------- */
  function toggleSidebar(open) {
    isSidebarOpen = open;
    updateSidebarUI();
  }

  function updateSidebarUI() {
    if (isSidebarOpen) {
      // 사이드바 열림
      $('#sidebar').removeClass('collapsed');
      $('#sidebarHeader').show();
      $('#topBarButtons').hide();
    } else {
      // 사이드바 닫힘
      $('#sidebar').addClass('collapsed');
      $('#sidebarHeader').hide();
      $('#topBarButtons').show();
    }
  }

  /* -----------------------------
   * 새 채팅 만들기 (예시)
   * ----------------------------- */
  function createNewChatOnServer() {
    $.ajax({
      url: '/api/newChat', // worker.js에 구현 필요
      method: 'POST',
      success: function(res) {
        // res: { chatId, title, ... }
        fetchChatHistoryList();
        if (res.chatId) loadChat(res.chatId);
      },
      error: function(err) {
        console.error('Failed to create new chat', err);
      }
    });
  }

  /* -----------------------------
   * 채팅 목록 불러오기
   * ----------------------------- */
  function fetchChatHistoryList() {
    $.ajax({
      url: '/api/chatHistory',
      method: 'GET',
      success: function(res) {
        const list = res.history || [];
        $('#historyList').empty();
        list.forEach(item => {
          const li = $('<li>').click(() => loadChat(item.chatId));
          const spanTitle = $('<span>').text(item.title);

          const optionsBtn = $('<button class="chat-options-btn">').html('&#8230;');
          const optionsMenu = $(`
            <div class="chat-options-menu">
              <a href="#" class="renameChatLink">이름 바꾸기</a>
              <a href="#" class="deleteChatLink">삭제</a>
            </div>
          `);

          optionsBtn.on('click', function(e) {
            e.stopPropagation();
            optionsMenu.toggle();
          });

          optionsMenu.find('.renameChatLink').click(function(e) {
            e.preventDefault();
            e.stopPropagation();
            const newName = prompt('새 이름을 입력하세요', item.title);
            if (newName) {
              renameChatOnServer(item.chatId, newName);
            }
            optionsMenu.hide();
          });
          optionsMenu.find('.deleteChatLink').click(function(e) {
            e.preventDefault();
            e.stopPropagation();
            if (confirm('정말 이 채팅을 삭제하시겠습니까?')) {
              deleteChatOnServer(item.chatId);
            }
            optionsMenu.hide();
          });

          li.append(spanTitle, optionsBtn, optionsMenu);
          $('#historyList').append(li);
        });
      },
      error: function(err) {
        console.error('Failed to fetch chat history', err);
      }
    });
  }

  /* -----------------------------
   * 채팅 삭제 (예시)
   * ----------------------------- */
  function deleteChatOnServer(chatId) {
    $.ajax({
      url: `/api/chatHistory/${chatId}`,
      method: 'DELETE',
      success: function() {
        alert('삭제되었습니다.');
        fetchChatHistoryList();
        if (currentChatId === chatId) {
          currentChatId = null;
          $('#messagesArea').empty();
        }
      },
      error: function(err) {
        console.error('Failed to delete chat', err);
      }
    });
  }

  /* -----------------------------
   * 채팅 이름 바꾸기 (예시)
   * ----------------------------- */
  function renameChatOnServer(chatId, newTitle) {
    $.ajax({
      url: `/api/chatHistory/${chatId}`,
      method: 'PATCH',
      contentType: 'application/json',
      data: JSON.stringify({ title: newTitle }),
      success: function() {
        fetchChatHistoryList();
      },
      error: function(err) {
        console.error('Failed to rename chat', err);
      }
    });
  }

  /* -----------------------------
   * 프로필 정보 불러오기
   * ----------------------------- */
  function fetchProfile() {
    $.ajax({
      url: '/api/profile',
      method: 'GET',
      success: function(res) {
        if (res.email) {
          $('#profileEmail').text(res.email);
        }
        if(res.profileImage) {
          $('#profileTab img').attr('src', res.profileImage);
        }
      },
      error: function(err) {
        console.error('Failed to fetch profile', err);
      }
    });
  }

  /* -----------------------------
   * 채팅 불러오기
   * ----------------------------- */
  function loadChat(chatId) {
    currentChatId = chatId;
    $('#messagesArea').empty();
    if (sseSource) {
      sseSource.close();
      sseSource = null;
    }

    $.ajax({
      url: `/api/chatHistory/${chatId}`,
      method: 'GET',
      success: function(res) {
        (res.messages || []).forEach(msg => {
          addMessage(msg.role, msg.content);
        });
      },
      error: function(err) {
        console.error('Failed to load chat:', err);
      }
    });
  }

  /* -----------------------------
   * 사용자 메시지 전송
   * ----------------------------- */
  function sendUserMessage() {
    const text = $('#userInput').val().trim();
    if (!text) return;

    addMessage('user', text);
    $('#userInput').val('');

    if (sseSource) {
      sseSource.close();
      sseSource = null;
    }

    $.ajax({
      url: '/api/chatStream',
      method: 'POST',
      contentType: 'application/json',
      data: JSON.stringify({
        message: text,
        chatId: currentChatId
      }),
      success: function(res) {
        currentChatId = res.chatId;
        startStream(res.chatId);
      },
      error: function(err) {
        console.error('Failed to send message:', err);
      }
    });
  }

  /* -----------------------------
   * SSE로 스트리밍 데이터 수신
   * ----------------------------- */
  function startStream(chatId) {
    sseSource = new EventSource(`/api/stream/${chatId}`);
    let assistantMsgId = addMessage('assistant', '');

    sseSource.addEventListener('message', function(e) {
      if (e.data === '[DONE]') {
        sseSource.close();
        sseSource = null;
        return;
      }
      appendToMessage(assistantMsgId, e.data);
    });

    sseSource.onerror = function(err) {
      console.error('SSE error:', err);
      sseSource.close();
      sseSource = null;
    };
  }

  /* -----------------------------
   * 채팅 영역에 메시지 추가
   * ----------------------------- */
  function addMessage(role, content) {
    const messageId = 'msg_' + Date.now() + Math.floor(Math.random() * 10000);
    const $msgBubble = $('<div class="message-bubble">').attr('id', messageId).addClass(role);

    // 1) 마크다운 → HTML 파싱
    const rawHtml = marked.parse(content || '');
    // 2) XSS 방지를 위해 sanitize
    const safeHtml = DOMPurify.sanitize(rawHtml);

    // 3) safeHtml을 말풍선에 삽입
    const $bubbleContent = $('<div class="bubble-content">').html(safeHtml);
    if(role === 'assistant') {
      $bubbleContent.addClass('markdown');
    }
    $msgBubble.append($bubbleContent);
    $('#messagesArea').append($msgBubble);

    // 스크롤 하단 고정
    const messagesArea = document.getElementById('messagesArea');
    messagesArea.scrollTop = messagesArea.scrollHeight;

    return messageId;
  }

  /* -----------------------------
   * 기존 메시지에 스트리밍 내용 추가
   * ----------------------------- */
  function appendToMessage(msgId, chunk) {
    const $msgBubble = $('#' + msgId).find('.bubble-content');
    // chunk(문자열)를 기존에 이어붙임
    // 1) 기존 내용 + 새 chunk
    const currentHtml = $msgBubble.html() || '';
    // 하지만 여기서 마크다운 실시간 파싱은 까다로우므로,
    // 간단히 "합친 텍스트"를 다시 MarkDown 처리 → 성능 고려 필요
    // (정교하게 하려면, SSE chunk를 모으고 마지막에 한 번만 파싱하는 방법도 있음)

    // a) 기존 HTML을 그대로 텍스트로 다시 바꾸거나,
    // b) chunk 단위로 concat 후 한 번에 parse
    // 여기서는 간단히 "append buffer" 아이디어로 시연

    // 1) hidden attribute로 raw 텍스트를 보관한다고 가정
    let rawText = $msgBubble.data('rawText') || '';
    rawText += chunk;
    $msgBubble.data('rawText', rawText);

    // 2) rawText 전체를 다시 마크다운 파싱 → HTML
    const rawHtml = marked.parse(rawText);
    const safeHtml = DOMPurify.sanitize(rawHtml);
    $msgBubble.html(safeHtml);

    // 스크롤 하단 고정
    const messagesArea = document.getElementById('messagesArea');
    messagesArea.scrollTop = messagesArea.scrollHeight;
  }
</script>
</body>
</html>
