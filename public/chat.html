<!DOCTYPE html>
<html lang="ko" data-bs-theme="dark">
<head>
  <meta charset="UTF-8" />
  <title>AreumGPT</title>
  <!-- Bootstrap 5 -->
  <link
          href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
          rel="stylesheet"
  >
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">
  <!-- jQuery -->
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.4/dist/jquery.min.js"></script>
  <!-- Bootstrap Bundle (JS) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- 마크다운 파싱 라이브러리 (marked) + XSS 방어 (DOMPurify) -->
  <script src="https://cdn.jsdelivr.net/npm/marked@4.3.0/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@2.4.1/dist/purify.min.js"></script>

  <!-- highlight.js (핵심) -->
   <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/highlight.min.js" integrity="sha512-EBLzUL8XLl+va/zAsmXwS7Z2B1F9HUHkZwyS/VKwh3S7T/U0nF4BaU29EP/ZSf6zgiIxYAnKLu6bJ8dqpmX5uw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/languages/javascript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/languages/python.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/styles/atom-one-dark.min.css" integrity="sha512-Jk4AqjWsdSzSWCSuQTfYRIF84Rq/eV0G2+tu07byYwHcbTGfdmLrHjUSwvzp5HvbiqK4ibmNwdcG49Y5RGYPTg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  

  <style>
    body {
      background-color: #212121; /* 다크모드 느낌 */
      color: #e0e0e0;
      margin: 0;
      padding: 0;
      height: 100vh;
      overflow: hidden;
    }
    .chat-container {
      display: flex;
      height: 100vh;
      overflow: hidden;
    }
    /* --- 사이드바 --- */
    .sidebar {
      background-color: #171717;
      height: 100%;
      overflow-y: auto;
      width: 260px;
      position: relative;
      transition: width 0.3s;
    }
    .sidebar.collapsed {
      width: 0;
      overflow: hidden;
    }
    /* 사이드바 헤더(버튼들) */
    .sidebar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 10px;
    }

    /* 채팅 목록 */
    .chat-history-list {
      list-style: none;
      padding-left: 0.75rem;
      padding-right: 0.75rem;
      margin: 0;
    }
    .chat-history-list li {
      position: relative;
      padding: 6px;
      cursor: pointer;
      border-radius: 4px;
    }
    .chat-history-list span {
      display: block;
      font-size: .88rem;
      white-space: nowrap;
      mask-image: linear-gradient(90deg, #000, #000 84%, transparent 89%, transparent);
      width: 100%;
    }
    .chat-history-list li:hover {
      background-color: #212121;
    }

    .chat-options-btn {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      display: none; /* 기본은 숨김 */
      background: none;
      border: none;
      color: #ccc;
      font-size: 16px;
      cursor: pointer;
    }
    .chat-history-list li:hover .chat-options-btn {
      display: inline;
    }
    .chat-options-menu {
      position: absolute;
      right: 40px;
      top: 50%;
      transform: translateY(-50%);
      background-color: #2e2e2e;
      border: 1px solid #555;
      border-radius: 8px;
      display: none;
      z-index: 10;
      padding: 12px;
    }
    .chat-options-menu a {
      color: #fff;
      text-decoration: none;
      display: block;
      padding: 4px 8px;
      font-size: 14px;
      white-space: nowrap;
    }
    .chat-options-menu a:hover {
      background-color: #4f4f4f;
    }

    /* --- 메인 채팅 --- */
    .main-chat {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      position: relative;
    }
    .top-bar {
      background-color: #212121;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 20px;
      border-bottom: 1px solid #555;
      position: relative;
    }
    /* 메인 상단 바의 버튼 세트 */
    .top-bar-buttons {
      display: none; /* 기본은 숨김 */
    }
    .message-container{
      flex: 1;
      overflow-y: auto;
    }
    .messages-area {
      padding: 20px;
      max-width: 48rem;
      width: 100%;
      margin: 0 auto;
    }
    .message-bubble {
      margin-bottom: 32px;
      opacity: 0;
      animation: fadeIn 0.3s forwards;
      line-height: 1.5;
    }
    .message-bubble.user {
      text-align: right;
    }
    .message-bubble.assistant {
      text-align: left;
    }
    .bubble-content {
      display: inline-block;
      padding: 10px 15px;
      border-radius:22px;
    }
    .user .bubble-content {
      background-color: #303030;
      color: #fff;
    }
    .user .bubble-content p {
        margin: 0;
    }
    .assistant .bubble-content {
      color: #e0e0e0;
    }

    @keyframes fadeIn {
      to { opacity: 1; }
    }
    /* --- 입력 영역 (다크모드) --- */
    .bottom-bar {
      padding: 10px 20px;
      border-top: 1px solid #555;
      background-color: #303030;
      border-radius: 22px;
      width: 100%;
      max-width: 44rem;
      margin: 0 auto;
    }
    .form-control {
      background-color: #333;
      color: #e0e0e0;
      border: 1px solid #555;
    }
    .form-control:focus {
      background-color: #424242;
      color: #fff;
      outline: none;
      box-shadow: none;
    }

    /* --- 프로필 --- */
    .profile-tab {
      cursor: pointer;
      display: flex;
      align-items: center;
    }
    .profile-tab img {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      margin-right: 8px;
    }
    .profile-dropdown {
      position: absolute;
      top: 50px;
      right: 20px;
      background-color: #3a3a3a;
      border: 1px solid #555;
      border-radius: 4px;
      display: none;
      padding: 10px;
      z-index: 999;
    }
    .profile-dropdown a {
      color: #fff;
      text-decoration: none;
      display: block;
      padding: 5px 0;
    }
    .profile-dropdown a:hover {
      background-color: #4f4f4f;
    }
    /* 스크롤바 커스텀 (선택사항) */
    ::-webkit-scrollbar {
      width: 8px;
    }
    ::-webkit-scrollbar-track {
      background: #3a3a3a;
    }
    ::-webkit-scrollbar-thumb {
      background: #555;
    }

    /*마크다운 스타일*/

    .markdown pre {
      margin-top: .5rem
    }

    .markdown pre:first-child {
      margin-top: 0
    }

    .markdown h1 {
      font-weight: 700;
      letter-spacing: -.04rem
    }

    .markdown h1:first-child {
      margin-top: 0
    }

    .markdown h2 {
      font-weight: 600;
      margin-bottom: 1rem;
      margin-top: 2rem
    }

    .markdown h2:first-child {
      margin-top: 0
    }

    .markdown h3 {
      font-weight: 600;
      margin-bottom: .5rem;
      margin-top: 1rem
    }

    .markdown h3:first-child {
      margin-top: 0
    }

    .markdown h4 {
      font-weight: 600;
      margin-bottom: .5rem;
      margin-top: 1rem
    }

    .markdown h4:first-child {
      margin-top: 0
    }

    .markdown h5 {
      font-weight: 600
    }

    .markdown h5:first-child {
      margin-top: 0
    }

    .markdown blockquote {
      --tw-border-opacity: 1;
      border-color: rgb(155 155 155/var(--tw-border-opacity));
      line-height: 1.5rem;
      margin: 0;
      padding-bottom: .5rem;
      padding-top: .5rem
    }

    [dir=ltr] .markdown blockquote {
      border-left-width: 2px;
      padding-left: 1rem
    }

    [dir=rtl] .markdown blockquote {
      border-right-width: 2px;
      padding-right: 1rem
    }

    .markdown p {
      margin-bottom: .5rem
    }

    .markdown p:not(:first-child) {
      margin-top: .5rem
    }

    .markdown p+:where(ol,ul) {
      margin-top: 0
    }

    .markdown :where(ol,ul)>li>:last-child {
      margin-bottom: 0
    }

    .markdown :where(ol,ul)>li>:first-child {
      margin-bottom: 0;
      margin-top: 0
    }

    .markdown li {
      margin-top: .25rem;
      margin-bottom: .25rem;
    }

    .prose :where(ol>li):not(:where([class~=not-prose] *))::marker {
      font-weight: 400
    }

    .prose :where(hr):not(:where([class~=not-prose] *)) {
        border-top-width: 1px;
        margin-bottom: 3em;
        margin-top: 3em
    }

    .hljs {
      background: #171717;
    }

    .code-block {
      margin: 1rem 0!important;
      border: 1px solid #555;
      border-radius: 5px;
      background: #171717;
      position: relative;
    }
    .code-block-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #3a3a3a;
      border-bottom: 1px solid #555;
      padding: 0.5rem 1rem;
    }
    .code-block-header .language-label {
      font-size: 0.9rem;
      color: #ccc;
      display: flex;
      align-items: center;
    }
    .code-block-header .language-label i {
      margin-right: 6px; /* 아이콘이 있을 경우 */
    }
    .copy-button {
      cursor: pointer;
      background: none;
      border: none;
      color: #ccc;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
    }
    .copy-button:hover {
      color: #fff;
    }
    .copy-button i {
      margin-right: 4px;
    }
    pre {
      margin: 0;
      padding: 0.5rem;
      overflow: auto;
    }
    code {
      font-family: "Fira Code", monospace;
      font-size: 0.9rem;
    }

  </style>
</head>
<body>
<div class="chat-container">
  <!-- 사이드바 -->
  <div class="sidebar" id="sidebar">
    <div class="sidebar-header" id="sidebarHeader">
      <!-- 사이드바 열려 있을 때 보이는 버튼 -->
      <button id="toggleSidebarBtnSide" class="btn btn-sm btn-secondary">&laquo;</button>
      <button id="newChatBtnSide" class="btn btn-sm btn-primary">새 채팅</button>
    </div>
    <ul id="historyList" class="chat-history-list"></ul>
  </div>

  <!-- 메인 채팅 영역 -->
  <div class="main-chat">
    <!-- 상단 바 -->
    <div class="top-bar">
      <h5 class="m-0 fw-bold">GPT-4o-mini</h5>

      <!-- 사이드바가 닫혀있을 때 나타날 버튼 세트 -->
      <div class="top-bar-buttons" id="topBarButtons">
        <button id="toggleSidebarBtnTop" class="btn btn-sm btn-secondary">&raquo;</button>
        <button id="newChatBtnTop" class="btn btn-sm btn-primary">새 채팅</button>
      </div>

      <div class="profile-tab" id="profileTab">
        <img src="" alt="Profile"/>
        <span id="profileEmail">User</span>
      </div>
      <!-- 프로필 드롭다운 -->
      <div class="profile-dropdown" id="profileDropdown">
        <a href="#" id="logoutBtn">로그아웃</a>
      </div>
    </div>

    <!-- 메시지 영역 -->
    <div class="message-container">
      <div id="messagesArea" class="messages-area"></div>
    </div>
    

    <!-- 입력 영역 -->
    <div class="bottom-bar mb-1">
      <div class="input-group">
        <textarea id="userInput" class="form-control" rows="1" placeholder="무엇이든 물어보세요"></textarea>
        <button id="sendBtn" class="btn btn-primary">전송</button>
      </div>
    </div>
    <p class="text-muted small m-auto">AreumGPT는 실수를 할 수 있습니다.</p>

  </div>
</div>

<script>

  // 마크다운 옵션 (줄바꿈/breaks, GFM 등)
  marked.setOptions({
    breaks: true,     // 일반 줄바꿈도 <br>로 처리
    gfm: true         // GitHub Flavored Markdown
  });

  let sseSource = null;
  let currentChatId = null;
  let isSidebarOpen = true; // 사이드바 초기 상태 (열림)

  /* 
  * 2) Highlight 함수
  *    - lang이 알려져 있으면 hljs.highlight(lang, code)
  *    - 아니면 hljs.highlightAuto(code)
  */
  function highlightCode(code, lang) {
    if (lang && hljs.getLanguage(lang)) {
      return hljs.highlight(code, {language: lang}).value;
    } else {
      // 언어 정보가 없으면 자동 감지
      return hljs.highlightAuto(code).value;
    }
  }

  /**
 * 2) 커스텀 렌더러
 *    - code() 훅을 오버라이드하여
 *      ChatGPT 스타일의 code block을 구성
 */
const renderer = {
  code(code, infostring, escaped) {
    const lang = infostring || ""; // 언어 정보
    const highlighted = highlightCode(code, lang);
    const iconHtml = getLanguageIcon(lang);

    // 고유 ID(복사 기능에 사용)
    const codeBlockId = "codeblock-" + Math.random().toString(36).slice(2);

    return `
    <div class="code-block">
      <div class="code-block-header">
        <span class="language-label">${iconHtml} ${lang || 'Text'}</span>
        <button class="copy-button" onclick="copyCode('${codeBlockId}')">
          <i class="far fa-copy"></i>Copy
        </button>
      </div>
      <pre><code id="${codeBlockId}" class="hljs">${highlighted}</code></pre>
    </div>
    `;
  }
};

/**
 * 언어별 아이콘 예시
 */
 function getLanguageIcon(lang) {
  const lower = lang.toLowerCase();
  if (lower.startsWith('js') || lower.startsWith('javascript')) {
    return '<i class="fab fa-js-square" style="color: #f7df1e;"></i>';
  } else if (lower.startsWith('py') || lower.startsWith('python')) {
    return '<i class="fab fa-python" style="color: #3776ab;"></i>';
  } else {
    // 기본 아이콘
    return '<i class="fas fa-code"></i>';
  }
}

/**
 * 3) 복사 기능
 */
function copyCode(codeId) {
  const codeEl = document.getElementById(codeId);
  if (!codeEl) return;
  const codeText = codeEl.textContent;
  navigator.clipboard.writeText(codeText)
    .then(() => {
      alert('코드가 복사되었습니다!');
    })
    .catch(err => {
      console.error('복사 실패:', err);
    });
}

marked.use({ renderer });

  $(function() {
    // 프로필 탭 클릭 시 드롭다운 표시
    $('#profileTab').on('click', function() {
      $('#profileDropdown').toggle();
    });

    // 로그아웃
    $('#logoutBtn').click(function(e) {
      e.preventDefault();
      window.location.href = '/api/logout';
    });

    // 사이드바 열림/닫힘 토글
    $('#toggleSidebarBtnSide').click(function() {
      // 사이드바 "닫기" (버튼이 사이드바 안에 있을 때)
      toggleSidebar(false);
    });
    $('#toggleSidebarBtnTop').click(function() {
      // 사이드바 "열기" (버튼이 상단 바에 있을 때)
      toggleSidebar(true);
    });

    // 새 채팅 버튼 (사이드바 / 상단 바 둘 다 같은 함수)
    $('#newChatBtnSide').click(createNewChatOnServer);
    $('#newChatBtnTop').click(createNewChatOnServer);

    // 메시지 전송
    $('#sendBtn').click(sendUserMessage);
    // 엔터키 전송
    $('#userInput').keypress(function(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendUserMessage();
      }
    });

    // 초기 상태
    updateSidebarUI();

    // 사이드바의 기존 채팅목록 불러오기
    fetchChatHistoryList();

    // 프로필 정보 불러오기
    fetchProfile();
  });

  /* --------------------------------
   * 사이드바 열림/닫힘 상태 변경
   * -------------------------------- */
  function toggleSidebar(open) {
    isSidebarOpen = open;
    updateSidebarUI();
  }

  function updateSidebarUI() {
    if (isSidebarOpen) {
      // 사이드바 열림
      $('#sidebar').removeClass('collapsed');
      $('#sidebarHeader').show();
      $('#topBarButtons').hide();
    } else {
      // 사이드바 닫힘
      $('#sidebar').addClass('collapsed');
      $('#sidebarHeader').hide();
      $('#topBarButtons').show();
    }
  }

  /* -----------------------------
   * 새 채팅 만들기 (예시)
   * ----------------------------- */
  function createNewChatOnServer() {
    $.ajax({
      url: '/api/newChat', // worker.js에 구현 필요
      method: 'POST',
      success: function(res) {
        // res: { chatId, title, ... }
        fetchChatHistoryList();
        if (res.chatId) loadChat(res.chatId);
      },
      error: function(err) {
        console.error('Failed to create new chat', err);
      }
    });
  }

  /* -----------------------------
   * 채팅 목록 불러오기
   * ----------------------------- */
  function fetchChatHistoryList() {
    $.ajax({
      url: '/api/chatHistory',
      method: 'GET',
      success: function(res) {
        const list = res.history || [];
        $('#historyList').empty();
        list.forEach(item => {
          const li = $('<li>').click(() => loadChat(item.chatId));
          const spanTitle = $('<span>').text(item.title);

          const optionsBtn = $('<button class="chat-options-btn">').html('&#8230;');
          const optionsMenu = $(`
            <div class="chat-options-menu">
              <a href="#" class="renameChatLink border-bottom">이름 바꾸기</a>
              <a href="#" class="deleteChatLink">삭제</a>
            </div>
          `);

          optionsBtn.on('click', function(e) {
            e.stopPropagation();
            optionsMenu.toggle();
          });

          optionsMenu.find('.renameChatLink').click(function(e) {
            e.preventDefault();
            e.stopPropagation();
            const newName = prompt('새 이름을 입력하세요', item.title);
            if (newName) {
              renameChatOnServer(item.chatId, newName);
            }
            optionsMenu.hide();
          });
          optionsMenu.find('.deleteChatLink').click(function(e) {
            e.preventDefault();
            e.stopPropagation();
            if (confirm('정말 이 채팅을 삭제하시겠습니까?')) {
              deleteChatOnServer(item.chatId);
            }
            optionsMenu.hide();
          });

          li.append(spanTitle, optionsBtn, optionsMenu);
          $('#historyList').append(li);
        });
      },
      error: function(err) {
        console.error('Failed to fetch chat history', err);
      }
    });
  }

  /* -----------------------------
   * 채팅 삭제 (예시)
   * ----------------------------- */
  function deleteChatOnServer(chatId) {
    $.ajax({
      url: `/api/chatHistory/${chatId}`,
      method: 'DELETE',
      success: function() {
        alert('삭제되었습니다.');
        fetchChatHistoryList();
        if (currentChatId === chatId) {
          currentChatId = null;
          $('#messagesArea').empty();
        }
      },
      error: function(err) {
        console.error('Failed to delete chat', err);
      }
    });
  }

  /* -----------------------------
   * 채팅 이름 바꾸기 (예시)
   * ----------------------------- */
  function renameChatOnServer(chatId, newTitle) {
    $.ajax({
      url: `/api/chatHistory/${chatId}`,
      method: 'PATCH',
      contentType: 'application/json',
      data: JSON.stringify({ title: newTitle }),
      success: function() {
        fetchChatHistoryList();
      },
      error: function(err) {
        console.error('Failed to rename chat', err);
      }
    });
  }

  /* -----------------------------
   * 프로필 정보 불러오기
   * ----------------------------- */
  function fetchProfile() { 
    $.ajax({
      url: '/api/profile',
      method: 'GET',
      success: function(res) {
        if (res.email) {
          $('#profileEmail').text(res.email);
        }
        if(res.profileImage) {
          $('#profileTab img').attr('src', res.profileImage);
        }
      },
      error: function(err) {
        console.error('Failed to fetch profile', err);
      }
    });
  }

  /* -----------------------------
   * 채팅 불러오기
   * ----------------------------- */
  function loadChat(chatId) {
    currentChatId = chatId;
    $('#messagesArea').empty();
    if (sseSource) {
      sseSource.close();
      sseSource = null;
    }

    $.ajax({
      url: `/api/chatHistory/${chatId}`,
      method: 'GET',
      success: function(res) {
        (res.messages || []).forEach(msg => {
          addMessage(msg.role, msg.content);
        });
      },
      error: function(err) {
        console.error('Failed to load chat:', err);
      }
    });
  }

  /* -----------------------------
   * 사용자 메시지 전송
   * ----------------------------- */
  function sendUserMessage() {
    const text = $('#userInput').val().trim();
    if (!text) return;

    addMessage('user', text);
    $('#userInput').val('');

    if (sseSource) {
      sseSource.close();
      sseSource = null;
    }

    $.ajax({
      url: '/api/chatStream',
      method: 'POST',
      contentType: 'application/json',
      data: JSON.stringify({
        message: text,
        chatId: currentChatId
      }),
      success: function(res) {
        currentChatId = res.chatId;
        startStream(res.chatId);
      },
      error: function(err) {
        console.error('Failed to send message:', err);
      }
    });
  }

  /* -----------------------------
   * SSE로 스트리밍 데이터 수신
   * ----------------------------- */
  function startStream(chatId) {
    sseSource = new EventSource(`/api/stream/${chatId}`);
    let assistantMsgId = addMessage('assistant', '');
    let rawTextBuffer = '';

    sseSource.addEventListener('message', function(e) {
      if (e.data === '[DONE]') {
        sseSource.close();
        sseSource = null;

        // 스크롤 하단 고정
        const messagesArea = document.getElementById('messagesArea');
        messagesArea.scrollTop = messagesArea.scrollHeight;
        return;
      }
      rawTextBuffer += e.data.replace(/\\n/g, '\n');
      // 버퍼에 있는 텍스트를 파싱하여 업데이트
      const $msgBubble = $('#' + assistantMsgId).find('.bubble-content');
      const rawHtml = marked.parse(rawTextBuffer);
      const safeHtml = DOMPurify.sanitize(rawHtml);
      $msgBubble.html(safeHtml);
    });

    sseSource.onerror = function(err) {
      console.error('SSE error:', err);
      sseSource.close();
      sseSource = null;
    };
  }

  /* -----------------------------
   * 채팅 영역에 메시지 추가
   * ----------------------------- */
  function addMessage(role, content) {
    const messageId = 'msg_' + Date.now() + Math.floor(Math.random() * 10000);
    const $msgBubble = $('<div class="message-bubble">').attr('id', messageId).addClass(role);

    // 1) 마크다운 → HTML 파싱
    const rawHtml = marked.parse(content || '');
    // 2) XSS 방지를 위해 sanitize
    const safeHtml = DOMPurify.sanitize(rawHtml);

    // 3) safeHtml을 말풍선에 삽입
    const $bubbleContent = $('<div class="bubble-content">').html(safeHtml);
    if(role === 'assistant') {
      $bubbleContent.addClass('markdown');
      $bubbleContent.addClass('prose')
    }
    $msgBubble.append($bubbleContent);
    $('#messagesArea').append($msgBubble);

    // 스크롤 하단 고정
    const messagesArea = document.getElementById('messagesArea');
    messagesArea.scrollTop = messagesArea.scrollHeight;

    return messageId;
  }
</script>
</body>
</html>
